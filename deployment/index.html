
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.3.0, mkdocs-material-8.2.8">
    
    
      
        <title>How to deploy - dbFLow - Documentation</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.644de097.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.e6a45f82.min.css">
        
          
          
          <meta name="theme-color" content="#2094f3">
        
      
    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="slate" data-md-color-primary="blue" data-md-color-accent="">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#deployment" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="dbFLow - Documentation" class="md-header__button md-logo" aria-label="dbFLow - Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            dbFLow - Documentation
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              How to deploy
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  
  


  <li class="md-tabs__item">
    <a href=".." class="md-tabs__link">
      Home
    </a>
  </li>

      
        
  
  


  <li class="md-tabs__item">
    <a href="../concept/" class="md-tabs__link">
      The Concept
    </a>
  </li>

      
        
  
  


  <li class="md-tabs__item">
    <a href="../getting_started/" class="md-tabs__link">
      How to setup
    </a>
  </li>

      
        
  
  
    
  


  <li class="md-tabs__item">
    <a href="./" class="md-tabs__link md-tabs__link--active">
      How to deploy
    </a>
  </li>

      
        
  
  


  <li class="md-tabs__item">
    <a href="../changelog/" class="md-tabs__link">
      Generating a changelog
    </a>
  </li>

      
        
  
  


  <li class="md-tabs__item">
    <a href="../migrating/" class="md-tabs__link">
      Migrating from previous
    </a>
  </li>

      
        
  
  


  <li class="md-tabs__item">
    <a href="../tutorial/" class="md-tabs__link">
      A Tutorial
    </a>
  </li>

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="dbFLow - Documentation" class="md-nav__button md-logo" aria-label="dbFLow - Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    dbFLow - Documentation
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../concept/" class="md-nav__link">
        The Concept
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../getting_started/" class="md-nav__link">
        How to setup
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          How to deploy
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        How to deploy
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#build" class="md-nav__link">
    build
  </a>
  
    <nav class="md-nav" aria-label="build">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#init" class="md-nav__link">
    init
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patch" class="md-nav__link">
    patch
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#release" class="md-nav__link">
    release
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#apply" class="md-nav__link">
    apply
  </a>
  
    <nav class="md-nav" aria-label="apply">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#init_1" class="md-nav__link">
    init
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patch_1" class="md-nav__link">
    patch
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../changelog/" class="md-nav__link">
        Generating a changelog
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../migrating/" class="md-nav__link">
        Migrating from previous
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../tutorial/" class="md-nav__link">
        A Tutorial
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#build" class="md-nav__link">
    build
  </a>
  
    <nav class="md-nav" aria-label="build">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#init" class="md-nav__link">
    init
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patch" class="md-nav__link">
    patch
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#release" class="md-nav__link">
    release
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#apply" class="md-nav__link">
    apply
  </a>
  
    <nav class="md-nav" aria-label="apply">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#init_1" class="md-nav__link">
    init
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patch_1" class="md-nav__link">
    patch
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                


<h1 id="deployment">Deployment</h1>
<p>As already described in the <a href="concept">concept</a> dbFlow knows two types of releases. One is the initial release, which imports the complete product against empty schemas or clears them first, and the other is the patch release, which determines the delta of two commit levels and applies it on top to an existing installation.</p>
<p><img alt="" src="../images/depot_and_flow.png" /></p>
<p>A release is created in two steps.</p>
<ul>
<li>Step 1: <strong>build</strong> - This is where the artifact is created.</li>
<li>Step 2: <strong>apply</strong> - This is where the artifact is deployed to the respective target environment.</li>
</ul>
<div class="admonition danger">
<p class="admonition-title">Warning</p>
<p>Remember, during an init, the target schemas are cleared at the beginning. All objects will be dropped!</p>
</div>
<h2 id="build">build</h2>
<p>The build.sh script is used to create the so-called build file or artifact. This is used to create the actual release based on the state of the files in the directory tree / Git repo.
As with any dbFlow script, you can display the possible parameters by omitting the parameters or explicitly with the <code>--help</code> parameter.</p>
<p>The build.sh script creates a tar ball with all relevant files and stores it in the depot. The location of the depot is determined in the file apply.env.</p>
<h3 id="init">init</h3>
<p>In an <strong>init</strong>ial release, all files from the database directories are determined and imported in a specific order. The files from the directories <code>\*/[ddl|dml]/patch/\*</code> and <code>\*/tables/tables_ddl</code> are ignored.</p>
<p>By using the flag <code>-i/--init</code> an <strong>init</strong>ial release is created. Additionally you need the target version of the release. With the flag <code>-v/--version</code> you name the version of the release.
The release itself is created from the current branch. If you want to create a release from the test branch, you have to switch there with Git first.</p>
<div class="admonition info">
<p class="admonition-title">Order of the directories</p>
<p>.hooks/pre sequences tables indexes/primaries indexes/uniques indexes/defaults constraints/primaries constraints/foreigns constraints/checks constraints/uniques contexts policies sources/types sources/packages sources/functions sources/procedures views mviews sources/triggers jobs tests/packages ddl/init dml/init dml/base .hooks/post</p>
</div>
<div class="highlight"><pre><span></span><code>$ .dbFlow/build.sh --init --version <span class="m">1</span>.0.0
</code></pre></div>
<blockquote>
<p>If you name the version with "install" then the release will be applied directly.</p>
</blockquote>
<h3 id="patch">patch</h3>
<p>In a <strong>patch</strong> release, all changed files are determined from the database directories and applied in a specific order. Which files are considered as modified is determined by Git. With the parameters <code>-s/--start</code> (defaults to ORIG_HEAD) and <code>-e/--end</code> (defaults to HEAD) one can set these parameters explicitly. Which files become part of the <strong>patch</strong> can be output by using the <code>-l/--listfiles</code> flag.</p>
<blockquote>
<p>Start should always be at least one commit prior to the end commit.</p>
</blockquote>
<p>The files from the directories <code>\*/[ddl|dml]/init/\*</code> are ignored. Additionally there is the import switch, which says, that if the table to be changed exists in the <code>table</code> folder <strong>AND</strong> in the <code>table_ddl</code> folder, <strong>ONLY</strong> the files with the same name from the <code>table_ddl</code> folder are imported.</p>
<p>By using the flag <code>-p/--patch</code> a patch release is created. Additionally you need the target version of the release. With the flag <code>-v/--version</code> you name the version of the release.</p>
<div class="admonition info">
<p class="admonition-title">Order of the directories</p>
<p>.hooks/pre ddl/patch/pre_${branch} dml/patch/pre_${branch} ddl/patch/pre dml/patch/pre sequences tables tables/tables_ddl indexes/primaries indexes/uniques indexes/defaults constraints/primaries constraints/foreigns constraints/checks constraints/uniques contexts policies sources/types sources/packages sources/functions sources/procedures views mviews sources/triggers jobs tests/packages ddl/patch/post_${branch} dml/patch/post_${branch} ddl/patch/post dml/base dml/patch/post .hooks/post</p>
</div>
<div class="highlight"><pre><span></span><code>$ .dbFlow/build.sh --patch --version <span class="m">1</span>.1.0
$ .dbFlow/build.sh --patch --version <span class="m">1</span>.2.0 --start <span class="m">1</span>.0.0
$ .dbFlow/build.sh --patch --version <span class="m">1</span>.3.0 --start 71563f65 --end ba12010a
$ .dbFlow/build.sh --patch --version <span class="m">1</span>.4.0 --start ORIG_HEAD --end HEAD
</code></pre></div>
<p>For example, by using stage branches, you can merge the current state of the develop branch into the test branch and build the release by implicitly using the Git variables HEAD and ORIG_HEAD.</p>
<div class="highlight"><pre><span></span><code><span class="c1"># make shure you have all changes</span>
@develop$ git pull

<span class="c1"># goto branch mapped to test-Stage</span>
@develop$ git checkout <span class="nb">test</span>

<span class="c1"># again: make shure you have all changes</span>
@test$ git pull

<span class="c1"># merge all chages from develop</span>
@test$ git merge develop

<span class="c1"># build the relase artifact</span>
@test$ .dbFlow/build.sh --patch --version <span class="m">1</span>.2.0
</code></pre></div>
<h2 id="release">release</h2>
<p>You don't have to do these steps manually if you use the release.sh script. Here you can simply specify your target branch and the script does the appropriate steps to merge the respective branches itself.
By omitting the parameters you can also see what is needed.</p>
<blockquote>
<p>release.sh does the handling / merging of the branches for you and calls build.sh afterwards.</p>
</blockquote>
<div class="highlight"><pre><span></span><code>  .dbFlow/release.sh --target master --version <span class="m">1</span>.2.3
</code></pre></div>
<p>To do a release test, the release script can build three artifacts for you (flag <code>-b/--build</code>). This functionality is for the so-called nightly builds. Here an initial release of the predecessor, a patch of the successor, and an initial release of the successor are built. Using a CI/CD server, such as Jenkins, you can then create these 3 artifacts and install them one after the other on the corresponding instance and of course test them.</p>
<div class="highlight"><pre><span></span><code>.dbFlow/release.sh --source develop --target master -b
</code></pre></div>
<h2 id="apply">apply</h2>
<p>The apply.sh command applies a release to the respective configured database. The artifact is fetched from the depot and unpacked into the appropriate directory. Afterwards the installation scripts are executed. The variable STAGE, from the file apply.env, is used to determine the source directory of a release. The build script stores the artifacts in a directory in a depot that contains the current branch name. The naming of the variable STAGE is now used to get the artifact matching the stage / database connection.</p>
<blockquote>
<p>With this method there can be n instances, which all point to the same depot directory.</p>
</blockquote>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>I recommend to create a corresponding instance directory for each database and to version it as well. This directory should also contain a .dbFlow - submodule. It is sufficient to copy the files apply.env and build.env into the directory and to adjust the database connection and the stage.</p>
</div>
<h3 id="init_1">init</h3>
<div class="admonition danger">
<p class="admonition-title">Warning</p>
<p>Importing an init release leads to data loss!</p>
</div>
<p>By specifying the <code>-i/--init</code> flag, an init release is retrieved from the depot and then imported. If no password is stored in the apply.env (this is recommended), it will be requested at the very beginning.</p>
<div class="highlight"><pre><span></span><code>$ .dbFlow/apply.sh --init --version <span class="m">1</span>.0.0
</code></pre></div>
<h3 id="patch_1">patch</h3>
<p>By specifying the <code>-p/--patch</code> flag, a patch release is searched for in the depot and then applied. If no password is stored in the apply.env (this is recommended), it will be requested at the very beginning.</p>
<div class="highlight"><pre><span></span><code>$ .dbFlow/apply.sh --patch --version <span class="m">1</span>.1.0
</code></pre></div>
<p>After the installation of a release, the artifact, as well as all resulting log and installation files are stored in the depot under the directory (success or failure). Failure of course only if the installation was aborted due to an error.</p>
<p>Now it can happen that you want to continue the installation after an interruption at the same place. For this the parameter <code>-r/--redolog</code> is used. If you specify the log file of the previous installation, it will be analyzed and continued with the step that leads to an abort.</p>

              
            </article>
          </div>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="Footer">
      
        
        <a href="../getting_started/" class="md-footer__link md-footer__link--prev" aria-label="Previous: How to setup" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              How to setup
            </div>
          </div>
        </a>
      
      
        
        <a href="../changelog/" class="md-footer__link md-footer__link--next" aria-label="Next: Generating a changelog" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              Generating a changelog
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "..", "features": ["navigation.tabs", "navigation.expand", "navigation.indexes", "navigation.sections"], "search": "../assets/javascripts/workers/search.5e67fbfe.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.c44cc438.min.js"></script>
      
    
  </body>
</html>